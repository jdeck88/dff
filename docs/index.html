<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Inventory</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        button {
            cursor: pointer;
            padding: 8px 12px;
            margin-top: 10px;
        }
        .toggle-switch {
            cursor: pointer;
            display: inline-block;
            width: 40px;
            height: 20px;
            background-color: #ccc;
            border-radius: 10px;
            position: relative;
            pointer-events: none;
        }
        .toggle-switch::before {
            content: "";
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: white;
            top: 1px;
            left: 1px;
            transition: 0.3s;
        }
        .toggle-switch.active {
            background-color: #4CAF50;
        }
        .toggle-switch.active::before {
            left: 20px;
        }
        .stock-input {
            width: 60px;
            text-align: center;
            border: none;
            background: transparent;
            pointer-events: none;
        }
        .editable {
            background: white;
            border: 1px solid #ddd;
            pointer-events: auto;
        }
    </style>
</head>
<body>

    <form onsubmit="event.preventDefault(); login();" style="float: right;">
        <input type="text" id="username" placeholder="Username" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit">Login</button>
        <button type="button" onclick="logout()">Logout</button>
    </form>

    <h2>Deck Family Farm Product Inventory</h2>
    <table>
        <thead>
            <tr>
                <th>Category</th>
                <th>Product Name</th>
                <th>Package Name</th>
                <th>Available On LL</th>
                <th>Visible</th>
                <th>Track Inventory</th>
                <th>Stock Inventory</th>
                <th>Actions</th> <!-- ✅ New column for Edit/Save/Cancel -->
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- Data will be populated dynamically here -->
        </tbody>
    </table>

    <script>
let editingRow = null;

async function login() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    try {
        const response = await fetch("http://biscicol.org/dff/v1/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
        });

        const data = await response.json();
        if (response.ok && data.token) {  
            //alert("Login successful! ✅");
            localStorage.setItem("token", data.token);
            loadData();
        } else {
            alert("Login failed! ❌ " + (data.error || "Unknown error"));
        }
    } catch (error) {
        console.error("Login Error:", error);
        alert("Network error! ❌ Unable to reach server.");
    }
}

async function loadData() {
    const token = localStorage.getItem("token");
    if (!token) {
        alert("Please log in first.");
        return;
    }

    try {
        const response = await fetch("http://biscicol.org/dff/v1/data", {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        });

        const data = await response.json();
        let tableBody = document.getElementById("tableBody");
        tableBody.innerHTML = "";

        data.forEach(row => {
            tableBody.innerHTML += `
                <tr data-id="${row.id}">
                    <td>${row.category}</td>
                    <td>${row.productName}</td>
                    <td>${row.packageName}</td>
                    <td>${row.available_on_ll ? 'True' : 'False'}</td>
                    <td><div class="toggle-switch ${row.visible ? 'active' : ''}" onclick="toggleEdit(this)"></div></td>
                    <td><div class="toggle-switch ${row.track_inventory ? 'active' : ''}" onclick="toggleEdit(this)"></div></td>
                    <td><input type="number" class="stock-input" value="${row.stock_inventory}" disabled></td>
                    <td>
                        <button onclick="editRow(${row.id}, this)">Edit</button>
                        <button onclick="saveRow(this)" style="display:none;">Save</button>
                        <button onclick="cancelRow()" style="display:none;">Cancel</button>
                    </td>
                </tr>`;
        });
    } catch (error) {
        console.error("Error fetching data:", error);
        alert("Session expired. Please log in again.");
    }
}

function toggleEdit(element) {
    if (editingRow !== null) {
        element.classList.toggle("active");
    }
}

function editRow(id, button) {
    if (editingRow !== null) return;
    editingRow = id;

    let row = document.querySelector(`tr[data-id="${id}"]`);
    row.querySelectorAll(".toggle-switch, .stock-input").forEach(el => {
        el.style.pointerEvents = "auto";
        if (el.tagName === "INPUT") {
            el.removeAttribute("disabled");
        }
    });

    button.style.display = "none";
    row.querySelector("button[onclick^='saveRow']").style.display = "inline";
    row.querySelector("button[onclick^='cancelRow']").style.display = "inline";
}

async function saveRow(button) {
    let row = button.closest("tr");  // ✅ Get the closest row
    let id = row.getAttribute("data-id");  // ✅ Extract the ID
    console.log(row)
    console.log(id)

    if (!id) {
        console.error("❌ Error: Row ID is missing!", row);
        alert("Error saving data. Missing row ID.");
        return;
    }

    let data = {
        visible: row.querySelectorAll(".toggle-switch")[0].classList.contains("active"),
        track_inventory: row.querySelectorAll(".toggle-switch")[1].classList.contains("active"),
        stock_inventory: row.querySelector(".stock-input").value
    };

    try {
        let response = await fetch(`http://biscicol.org/dff/v1/update/${id}`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${localStorage.getItem("token")}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            throw new Error("Failed to update data.");
        }

        //alert("✅ Changes saved successfully!");
        cancelRow();  // Lock the row after saving
    } catch (error) {
        console.error("❌ Error updating data:", error);
        alert("Failed to save changes. Please try again.");
    }
}

function cancelRow() {
    editingRow = null;
    loadData();
}

function logout() {
    localStorage.removeItem("token");
    document.getElementById("tableBody").innerHTML = "";
    alert("Logged out!");
}

window.onload = function() {
    if (localStorage.getItem("token")) {
        loadData();
    }
};
</script>

</body>
</html>
